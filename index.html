<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Quiz</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .panel {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        textarea, .quiz-area {
            width: calc(100% - 40px);
            border: none;
            font-size: 16px;
            line-height: 1.5;
            margin: 0 20px;
        }
        textarea {
            height: 150px;
            background-color: #f0f0f0;
            border-radius: 8px;
            padding: 10px;
            resize: vertical;
        }
        .quiz-area {
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        button {
            background-color: #0071e3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0077ed;
        }
        .hidden-word {
            background-color: #e0e0e0;
            border-radius: 4px;
            padding: 2px 4px;
            margin: 0 2px;
            display: inline-block;
            color: #e0e0e0;
            cursor: pointer;
        }
        .hidden-word.revealed {
            color: black;
            background-color: pink;
        }
        
        /* Writing mode input */
        .hidden-word-input {
            background-color: #fff;
            border: 2px solid #0071e3;
            border-radius: 4px;
            padding: 2px 6px;
            margin: 0 2px;
            display: inline-block;
            min-width: 60px;
            font-size: 16px;
            font-family: inherit;
            outline: none;
        }
        .hidden-word-input.correct {
            background-color: #c8e6c9;
            border-color: #4caf50;
            color: #2e7d32;
        }
        .hidden-word-input.incorrect {
            background-color: #ffcdd2;
            border-color: #f44336;
            animation: shake 0.3s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* Mode toggle buttons */
        .mode-toggle {
            display: flex;
            gap: 5px;
            background-color: #f0f0f0;
            padding: 4px;
            border-radius: 8px;
        }
        .mode-btn {
            padding: 6px 12px;
            border: none;
            background-color: transparent;
            color: #666;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .mode-btn:hover {
            background-color: #e0e0e0;
        }
        .mode-btn.active {
            background-color: #0071e3;
            color: white;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .controls-slider {
            margin-left: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .completion-tracker {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }
        .completion-label {
            font-weight: 600;
            color: #333;
        }
        .completion-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .completion-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: 1px solid #d0d0d0;
            background-color: #f6f6f6;
            color: #333;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .completion-btn:hover {
            background-color: #eaeaea;
        }
        .completion-value {
            min-width: 32px;
            text-align: center;
            font-weight: 600;
            color: #0071e3;
        }
        .percentage-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .percentage-btn {
            padding: 4px 10px;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            background-color: #f6f6f6;
            color: #333;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .percentage-btn:hover {
            background-color: #eaeaea;
        }
        .percentage-btn.active {
            background-color: #0071e3;
            color: white;
            border-color: #0071e3;
        }
        input[type="range"] {
            width: 200px;
        }
        .sentence {
            display: flex;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        .sentence-number {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 10px;
            width: 30px;
        }
        .number {
            font-weight: bold;
            color: #0071e3;
        }
        .sentence-buttons {
            display: flex;
            gap: 4px;
            margin-top: 2px;
        }
        .answer-btn, .copy-btn {
            width: 12px;
            height: 12px;
            border: none;
            background-color: #87CEFA;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: white;
            padding: 0;
        }
        .answer-btn {
            border-radius: 50%;
        }
        .copy-btn {
            border-radius: 2px;
        }
        .sentence-content {
            flex-grow: 1;
        }
        .sentence-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 10px;
            flex-shrink: 0;
        }
        .speak-btn {
            width: 24px;
            height: 24px;
            border: none;
            background-color: #ff9800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            border-radius: 6px;
            padding: 0;
            transition: background-color 0.2s;
        }
        .speak-btn:hover {
            background-color: #fb8c00;
        }
        .speak-btn[aria-pressed="true"] {
            background-color: #ef6c00;
        }
        .speak-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .loop-info {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: #5f5f5f;
            gap: 4px;
        }
        .loop-count-value {
            font-weight: 600;
            color: #333;
        }
        .check-box {
            width: 20px;
            height: 20px;
            border: 2px solid #a0a0a0;
            border-radius: 4px;
            margin-left: 10px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .check-box:hover {
            border-color: #4caf50;
            transform: scale(1.1);
        }
        .completed .check-box {
            background-color: #4caf50;
            border-color: #4caf50;
        }
        .completed .check-box::after {
            content: '✓';
            color: white;
            font-weight: bold;
        }
        .completed {
            opacity: 0.5;
        }
        #progress {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #0071e3;
            transition: width 0.3s ease;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 20px;
        }
        
        .modal-close {
            font-size: 28px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }
        
        .saved-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .saved-item {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .saved-item:hover {
            background-color: #f0f0f0;
        }
        
        .saved-item-info {
            flex-grow: 1;
            cursor: pointer;
        }
        
        .saved-item-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .saved-item-date {
            font-size: 12px;
            color: #666;
        }

        .saved-item-preview {
            font-size: 13px;
            color: #888;
            margin-top: 5px;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .saved-item-meta {
            font-size: 12px;
            color: #555;
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .saved-item-meta span {
            font-weight: 600;
            color: #0071e3;
        }

        .saved-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .saved-item-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.2s;
        }
        
        .saved-item-btn:hover {
            opacity: 0.8;
        }
        
        .load-btn {
            background-color: #0071e3;
            color: white;
        }
        
        .delete-btn {
            background-color: #f44336;
            color: white;
        }
        
        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 14px;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                gap: 15px;
            }
            
            .panel {
                padding: 15px;
                border-radius: 8px;
            }
            
            textarea, .quiz-area {
                width: 100%;
                margin: 0;
                font-size: 14px;
            }
            
            textarea {
                height: 120px;
            }
            
            .quiz-area {
                height: 300px;
            }
            
            .controls {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .controls-slider {
                margin-left: 0;
                display: flex;
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .percentage-buttons {
                justify-content: space-between;
            }
            
            .percentage-btn {
                flex: 1 1 calc(50% - 6px);
                text-align: center;
            }
            
            .completion-tracker {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .completion-controls {
                width: 100%;
            }
            
            button {
                width: 100%;
                padding: 12px 15px;
                font-size: 16px;
            }
            
            input[type="range"] {
                width: 100%;
            }
            
            .sentence {
                margin-bottom: 20px;
            }
            
            .sentence-number {
                width: 40px;
                margin-right: 8px;
            }
            
            .number {
                font-size: 14px;
            }
            
            .answer-btn, .copy-btn {
                width: 20px;
                height: 20px;
                font-size: 10px;
            }
            
            .sentence-actions {
                gap: 8px;
            }
            
            .check-box {
                width: 28px;
                height: 28px;
                margin-left: 8px;
                font-size: 18px;
            }
            
            .hidden-word {
                padding: 3px 5px;
                margin: 1px 2px;
                font-size: 14px;
                min-height: 24px;
                display: inline-flex;
                align-items: center;
            }
            
            .hidden-word-input {
                font-size: 14px;
                padding: 4px 8px;
                min-width: 50px;
            }
            
            .mode-toggle {
                padding: 3px;
            }
            
            .mode-btn {
                padding: 5px 10px;
                font-size: 12px;
            }
            
            #progress {
                font-size: 16px;
            }
            
            h2 {
                font-size: 20px;
                margin-top: 0;
            }
        }

        /* Small Mobile Styles */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .panel {
                padding: 12px;
            }
            
            .sentence-content {
                font-size: 13px;
                line-height: 1.6;
            }
            
            .toast {
                bottom: 10px;
                font-size: 14px;
            }
            
            button {
                padding: 14px 16px;
                font-size: 15px;
                font-weight: 500;
            }
            
            .sentence-actions {
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h2 style="margin: 0;">Input Text</h2>
                <button id="manage-saves-btn" style="padding: 8px 15px; font-size: 14px;">📚 My Quizzes</button>
            </div>
            <div style="margin-bottom: 10px;">
                <input type="text" id="quiz-title" placeholder="Quiz title (optional)" style="width: 100%; padding: 8px; border: 1px solid #d0d0d0; border-radius: 6px; font-size: 14px;">
            </div>
            <textarea id="input-text" placeholder="Enter your text here..."></textarea>
        </div>
        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Quiz</h2>
                <div class="mode-toggle">
                    <button class="mode-btn active" id="speaking-mode">🗣️ Speaking</button>
                    <button class="mode-btn" id="writing-mode">✍️ Writing</button>
                </div>
            </div>
            <div id="progress"></div>
            <div class="progress-bar">
                <div class="progress-bar-fill" style="width: 0%;"></div>
            </div>
            <div id="quiz-area" class="quiz-area"></div>
            <div class="controls">
                <button id="generate-quiz">Generate Quiz</button>
                <button id="play-all">Play All</button>
                <button id="download-quiz">Download Quiz</button>
                <div class="controls-slider">
                    <div class="percentage-buttons">
                        <button type="button" class="percentage-btn" data-value="0">0%</button>
                        <button type="button" class="percentage-btn" data-value="25">25%</button>
                        <button type="button" class="percentage-btn" data-value="50">50%</button>
                        <button type="button" class="percentage-btn" data-value="75">75%</button>
                        <button type="button" class="percentage-btn" data-value="100">100%</button>
                    </div>
                    <label for="hide-percentage">Hide percentage: <span id="percentage-value">20</span>%</label>
                    <input type="range" id="hide-percentage" min="0" max="100" value="20">
                </div>
            </div>
            <div class="completion-tracker">
                <span class="completion-label">Completion Count</span>
                <div class="completion-controls">
                    <button type="button" id="completion-decrement" class="completion-btn" aria-label="Decrease completion count">-</button>
                    <span id="completion-count" class="completion-value">0</span>
                    <button type="button" id="completion-increment" class="completion-btn" aria-label="Increase completion count">+</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>
    
    <!-- Save Management Modal -->
    <div id="save-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📚 My Saved Quizzes</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <button id="save-current-btn" style="width: 100%; padding: 12px; background-color: #4caf50; color: white; border: none; border-radius: 6px; font-size: 15px; cursor: pointer; margin-bottom: 10px;">
                        💾 Save Current Quiz
                    </button>
                    <div style="display: flex; gap: 10px;">
                        <button id="export-all-btn" style="flex: 1; padding: 10px; background-color: #2196f3; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            📤 Export All
                        </button>
                        <button id="import-btn" style="flex: 1; padding: 10px; background-color: #ff9800; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
                            📥 Import
                        </button>
                    </div>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
                <div id="saved-list" class="saved-list">
                    <!-- Saved quizzes will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const inputText = document.getElementById('input-text');
        const quizArea = document.getElementById('quiz-area');
        const generateQuizBtn = document.getElementById('generate-quiz');
        const downloadQuizBtn = document.getElementById('download-quiz');
        const playAllBtn = document.getElementById('play-all');
        const hidePercentage = document.getElementById('hide-percentage');
        const percentageValue = document.getElementById('percentage-value');
        const progressDiv = document.getElementById('progress');
        const toast = document.getElementById('toast');
        const speakingModeBtn = document.getElementById('speaking-mode');
        const writingModeBtn = document.getElementById('writing-mode');
        const quizTitle = document.getElementById('quiz-title');
        const manageSavesBtn = document.getElementById('manage-saves-btn');
        const saveModal = document.getElementById('save-modal');
        const modalClose = document.querySelector('.modal-close');
        const saveCurrentBtn = document.getElementById('save-current-btn');
        const savedList = document.getElementById('saved-list');
        const exportAllBtn = document.getElementById('export-all-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file-input');
        const percentageButtons = document.querySelectorAll('.percentage-btn');
        const completionDecrementBtn = document.getElementById('completion-decrement');
        const completionIncrementBtn = document.getElementById('completion-increment');
        const completionCountDisplay = document.getElementById('completion-count');
        
        const speechState = {
            currentIndex: null,
            currentButton: null,
            sentence: '',
            isLooping: false,
            utterance: null,
            loopTimeoutId: null
        };
        const speechSupported = 'speechSynthesis' in window && typeof SpeechSynthesisUtterance !== 'undefined';
        let preferredVoice = null;
        
        let currentMode = 'speaking'; // 'speaking' or 'writing'
        const STORAGE_KEY = 'memoryQuiz_savedQuizzes';
        const LOOP_COUNT_STORAGE_KEY = 'memoryQuiz_loopCounts_v1';
        let loopCountsMap = loadLoopCounts();
        let completionCount = 0;
        let currentLoadedQuizId = null;
        
        const globalPlaybackState = {
            isPlaying: false,
            currentIndex: 0,
            timeoutId: null,
            utterance: null,
            currentButton: null
        };

        if (speechSupported) {
            initializePreferredVoice();
        }

        generateQuizBtn.addEventListener('click', generateQuiz);
        downloadQuizBtn.addEventListener('click', downloadQuiz);
        playAllBtn.addEventListener('click', toggleGlobalPlayback);
        hidePercentage.addEventListener('input', updatePercentage);
        percentageButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const value = parseInt(btn.dataset.value, 10);
                if (Number.isNaN(value)) {
                    return;
                }
                hidePercentage.value = value;
                updatePercentage();
            });
        });
        completionDecrementBtn.addEventListener('click', () => changeCompletionCount(-1));
        completionIncrementBtn.addEventListener('click', () => changeCompletionCount(1));
        speakingModeBtn.addEventListener('click', () => switchMode('speaking'));
        writingModeBtn.addEventListener('click', () => switchMode('writing'));
        manageSavesBtn.addEventListener('click', openSaveModal);
        modalClose.addEventListener('click', closeSaveModal);
        saveCurrentBtn.addEventListener('click', saveCurrentQuiz);
        exportAllBtn.addEventListener('click', exportAllQuizzes);
        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', importQuizzes);
        
        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === saveModal) {
                closeSaveModal();
            }
        });
        
        // Auto-save current text
        inputText.addEventListener('input', () => {
            currentLoadedQuizId = null;
            autoSave();
        });
        quizTitle.addEventListener('input', () => {
            currentLoadedQuizId = null;
            autoSave();
        });
        
        // Load auto-saved text on startup
        loadAutoSave();

        function initializePreferredVoice() {
            const assignPreferredVoice = () => {
                try {
                    const voices = speechSynthesis.getVoices();
                    if (!voices || voices.length === 0) {
                        return;
                    }
                    const selected = pickEnglishVoice(voices);
                    if (selected) {
                        preferredVoice = selected;
                    } else if (!preferredVoice) {
                        preferredVoice = voices[0];
                    }
                } catch (error) {
                    console.error('Voice selection error:', error);
                }
            };

            assignPreferredVoice();
            if (typeof speechSynthesis.addEventListener === 'function') {
                speechSynthesis.addEventListener('voiceschanged', assignPreferredVoice);
            } else if (typeof speechSynthesis.onvoiceschanged !== 'undefined') {
                speechSynthesis.onvoiceschanged = assignPreferredVoice;
            }
        }

        function pickEnglishVoice(voices) {
            if (!voices || voices.length === 0) {
                return null;
            }
            const lowerCaseMatch = (voice, target) =>
                voice.lang && voice.lang.toLowerCase() === target;
            const startsWithEn = voice =>
                voice.lang && voice.lang.toLowerCase().startsWith('en');
            
            return voices.find(voice => lowerCaseMatch(voice, 'en-us')) ||
                voices.find(voice => lowerCaseMatch(voice, 'en-gb')) ||
                voices.find(startsWithEn) ||
                voices.find(voice => /english/i.test(voice.name)) ||
                null;
        }

        function ensurePreferredVoice() {
            if (!speechSupported) {
                return null;
            }
            if (preferredVoice) {
                return preferredVoice;
            }
            try {
                const voices = speechSynthesis.getVoices();
                if (voices && voices.length > 0) {
                    preferredVoice = pickEnglishVoice(voices) || voices[0];
                }
            } catch (error) {
                console.error('Unable to ensure preferred voice:', error);
            }
            return preferredVoice;
        }

        function configureUtterance(utterance) {
            if (!utterance) {
                return;
            }
            const voice = ensurePreferredVoice();
            if (voice) {
                utterance.voice = voice;
                utterance.lang = voice.lang || 'en-US';
            } else {
                utterance.lang = 'en-US';
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // Update button states
            if (mode === 'speaking') {
                speakingModeBtn.classList.add('active');
                writingModeBtn.classList.remove('active');
            } else {
                writingModeBtn.classList.add('active');
                speakingModeBtn.classList.remove('active');
            }
            
            // Regenerate quiz with new mode
            if (quizArea.innerHTML.trim() !== '') {
                generateQuiz();
            }
        }

        function updatePercentage() {
            const value = parseInt(hidePercentage.value, 10);
            percentageValue.textContent = value;
            setActivePercentageButton(value);
            autoSave();
        }
        
        function setActivePercentageButton(value) {
            percentageButtons.forEach(btn => {
                const btnValue = parseInt(btn.dataset.value, 10);
                if (btnValue === value) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function setCompletionCount(value, options = {}) {
            const normalized = Math.max(0, Number.isFinite(Number(value)) ? Math.floor(Number(value)) : 0);
            completionCount = normalized;
            updateCompletionDisplay();
            if (!options.skipAutoSave) {
                autoSave();
            }
            if (!options.skipSync) {
                syncCompletionCountToSavedQuiz();
            }
        }
        
        function changeCompletionCount(delta) {
            const target = Math.max(0, completionCount + delta);
            if (target === completionCount) {
                return;
            }
            setCompletionCount(target);
        }
        
        function updateCompletionDisplay() {
            if (completionCountDisplay) {
                completionCountDisplay.textContent = completionCount;
            }
        }
        
        function syncCompletionCountToSavedQuiz() {
            if (currentLoadedQuizId === null) {
                return;
            }
            const quizzes = getSavedQuizzes();
            const index = quizzes.findIndex(q => q.id === currentLoadedQuizId);
            if (index === -1) {
                return;
            }
            if (quizzes[index].completionCount === completionCount) {
                return;
            }
            quizzes[index].completionCount = completionCount;
            saveQuizzes(quizzes);
            renderSavedList();
        }
        
        // Auto-save functions
        function autoSave() {
            if (typeof localStorage === 'undefined') {
                return;
            }
            localStorage.setItem('memoryQuiz_autoSave', JSON.stringify({
                text: inputText.value,
                title: quizTitle.value,
                percentage: hidePercentage.value,
                completionCount: completionCount,
                loadedQuizId: currentLoadedQuizId
            }));
        }
        
        function loadAutoSave() {
            const saved = localStorage.getItem('memoryQuiz_autoSave');
            let completionLoaded = false;
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    inputText.value = data.text || '';
                    quizTitle.value = data.title || '';
                    if (data && Object.prototype.hasOwnProperty.call(data, 'percentage')) {
                        hidePercentage.value = data.percentage;
                    }
                    if (data && Object.prototype.hasOwnProperty.call(data, 'completionCount')) {
                        setCompletionCount(data.completionCount, { skipAutoSave: true, skipSync: true });
                        completionLoaded = true;
                    }
                    if (data && Object.prototype.hasOwnProperty.call(data, 'loadedQuizId')) {
                        currentLoadedQuizId = data.loadedQuizId;
                    } else {
                        currentLoadedQuizId = null;
                    }
                } catch (e) {
                    console.error('Error loading auto-save:', e);
                    currentLoadedQuizId = null;
                }
            } else {
                currentLoadedQuizId = null;
            }
            if (currentLoadedQuizId !== null) {
                const quizzes = getSavedQuizzes();
                const exists = quizzes.some(q => q.id === currentLoadedQuizId);
                if (!exists) {
                    currentLoadedQuizId = null;
                }
            }
            percentageValue.textContent = hidePercentage.value;
            setActivePercentageButton(parseInt(hidePercentage.value, 10));
            if (!completionLoaded) {
                updateCompletionDisplay();
            }
        }
        
        // Modal functions
        function openSaveModal() {
            renderSavedList();
            saveModal.style.display = 'block';
        }
        
        function closeSaveModal() {
            saveModal.style.display = 'none';
        }
        
        function getSavedQuizzes() {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
        }
        
        function saveQuizzes(quizzes) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(quizzes));
        }
        
        function saveCurrentQuiz() {
            const text = inputText.value.trim();
            if (!text) {
                showToast('Please enter some text first!');
                return;
            }
            
            const title = quizTitle.value.trim() || `Quiz ${new Date().toLocaleDateString()}`;
            const quizzes = getSavedQuizzes();
            
            const newQuiz = {
                id: Date.now(),
                title: title,
                text: text,
                percentage: hidePercentage.value,
                mode: currentMode,
                completionCount: completionCount,
                date: new Date().toISOString(),
                dateString: new Date().toLocaleString()
            };

            quizzes.unshift(newQuiz);
            saveQuizzes(quizzes);
            renderSavedList();
            currentLoadedQuizId = newQuiz.id;
            autoSave();
            showToast('Quiz saved! 💾');
        }
        
        function loadQuiz(id) {
            const quizzes = getSavedQuizzes();
            const quiz = quizzes.find(q => q.id === id);
            
            if (quiz) {
                inputText.value = quiz.text || '';
                quizTitle.value = quiz.title || '';
                const storedPercentage = Object.prototype.hasOwnProperty.call(quiz, 'percentage') ? quiz.percentage : 20;
                hidePercentage.value = storedPercentage;
                percentageValue.textContent = storedPercentage;
                setActivePercentageButton(parseInt(storedPercentage, 10));
                
                const storedCompletion = Object.prototype.hasOwnProperty.call(quiz, 'completionCount') ? quiz.completionCount : 0;
                setCompletionCount(storedCompletion, { skipAutoSave: true, skipSync: true });
                currentLoadedQuizId = quiz.id;

                if (quiz.mode) {
                    switchMode(quiz.mode);
                }

                closeSaveModal();
                showToast('Quiz loaded! 📖');
                autoSave();
            }
        }
        
        function deleteQuiz(id) {
            if (!confirm('Are you sure you want to delete this quiz?')) {
                return;
            }
            
            let quizzes = getSavedQuizzes();
            quizzes = quizzes.filter(q => q.id !== id);
            saveQuizzes(quizzes);
            renderSavedList();
            if (currentLoadedQuizId === id) {
                currentLoadedQuizId = null;
                autoSave();
            }
            showToast('Quiz deleted! 🗑️');
        }
        
        function renderSavedList() {
            const quizzes = getSavedQuizzes();
            
            if (quizzes.length === 0) {
                savedList.innerHTML = '<div class="empty-message">No saved quizzes yet.<br>Click "Save Current Quiz" to get started!</div>';
                return;
            }
            
            savedList.innerHTML = quizzes.map(quiz => {
                // Create preview text (first 100 characters)
                const previewSource = (quiz.text || '').trim();
                const previewText = previewSource.length > 100 
                    ? previewSource.substring(0, 100) + '...' 
                    : previewSource;
                const completionTotal = Math.max(0, parseInt(quiz.completionCount, 10) || 0);
                
                return `
                    <div class="saved-item">
                        <div class="saved-item-info" onclick="loadQuiz(${quiz.id})">
                            <div class="saved-item-title">${escapeHtml(quiz.title)}</div>
                            <div class="saved-item-date">📅 ${quiz.dateString}</div>
                            <div class="saved-item-preview">${escapeHtml(previewText)}</div>
                            <div class="saved-item-meta">✅ Completion Count: <span>${completionTotal}</span></div>
                        </div>
                        <div class="saved-item-actions">
                            <button class="saved-item-btn load-btn" onclick="loadQuiz(${quiz.id})">Load</button>
                            <button class="saved-item-btn delete-btn" onclick="deleteQuiz(${quiz.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Export all quizzes to JSON file
        function exportAllQuizzes() {
            const quizzes = getSavedQuizzes();
            
            if (quizzes.length === 0) {
                showToast('No quizzes to export!');
                return;
            }
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                quizzes: quizzes
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `memory-quiz-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast(`Exported ${quizzes.length} quizzes! 📤`);
        }
        
        // Import quizzes from JSON file
        function importQuizzes(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importData.quizzes || !Array.isArray(importData.quizzes)) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    const existingQuizzes = getSavedQuizzes();
                    const importCount = importData.quizzes.length;
                    
                    // Ask user about merge or replace
                    let mergeMode = true;
                    if (existingQuizzes.length > 0) {
                        mergeMode = confirm(
                            `You have ${existingQuizzes.length} existing quizzes.\n\n` +
                            `Click OK to MERGE (add ${importCount} more quizzes)\n` +
                            `Click Cancel to REPLACE (delete existing and import ${importCount} quizzes)`
                        );
                    }
                    
                    let newQuizzes;
                    if (mergeMode) {
                        // Merge: combine existing with imported (remove duplicates by ID)
                        const existingIds = new Set(existingQuizzes.map(q => q.id));
                        const uniqueImports = importData.quizzes.filter(q => !existingIds.has(q.id));
                        newQuizzes = [...existingQuizzes, ...uniqueImports];
                        showToast(`Merged! Added ${uniqueImports.length} new quizzes 📥`);
                    } else {
                        // Replace: use only imported quizzes
                        newQuizzes = importData.quizzes;
                        showToast(`Imported ${importCount} quizzes! 📥`);
                    }

                    newQuizzes = newQuizzes.map(quiz => {
                        const completionTotal = Math.max(0, parseInt(quiz.completionCount, 10) || 0);
                        return {
                            ...quiz,
                            completionCount: completionTotal
                        };
                    });

                    saveQuizzes(newQuizzes);
                    renderSavedList();
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Error importing file! ❌');
                }
            };
            
            reader.readAsText(file);
            
            // Reset input so same file can be selected again
            event.target.value = '';
        }
        
        // Make functions global for onclick handlers
        window.loadQuiz = loadQuiz;
        window.deleteQuiz = deleteQuiz;

        function normalizeSentence(sentence) {
            return (sentence || '').replace(/\s+/g, ' ').trim();
        }

        function buildLoopKey(sentence, index) {
            return `${normalizeSentence(sentence)}||${index}`;
        }

        function decodeLoopKey(encoded) {
            try {
                return decodeURIComponent(encoded);
            } catch (error) {
                return encoded;
            }
        }

        function loadLoopCounts() {
            if (typeof localStorage === 'undefined') {
                return new Map();
            }
            try {
                const raw = localStorage.getItem(LOOP_COUNT_STORAGE_KEY);
                if (!raw) {
                    return new Map();
                }
                const parsed = JSON.parse(raw);
                if (!parsed || typeof parsed !== 'object') {
                    return new Map();
                }
                const entries = Object.entries(parsed).map(([key, value]) => [key, Number(value) || 0]);
                return new Map(entries);
            } catch (error) {
                console.error('Failed to load loop counts:', error);
                return new Map();
            }
        }

        function saveLoopCounts() {
            if (typeof localStorage === 'undefined') {
                return;
            }
            try {
                const data = {};
                loopCountsMap.forEach((value, key) => {
                    data[key] = value;
                });
                localStorage.setItem(LOOP_COUNT_STORAGE_KEY, JSON.stringify(data));
            } catch (error) {
                console.error('Failed to save loop counts:', error);
            }
        }

        function getLoopCount(loopKey) {
            return loopCountsMap.get(loopKey) || 0;
        }

        function setLoopCount(loopKey, value) {
            loopCountsMap.set(loopKey, value);
            saveLoopCounts();
        }

        function generateQuiz() {
            const text = inputText.value;
            const sentences = text.split(/(?<=[.!?])\s+/);
            const percentToHide = parseInt(hidePercentage.value, 10) / 100;
            
            stopAllPlayback();
            
            // Save currently completed sentence indices
            const completedIndices = new Set();
            document.querySelectorAll('.sentence').forEach((sentenceEl, idx) => {
                if (sentenceEl.classList.contains('completed')) {
                    completedIndices.add(idx);
                }
            });
            
            const quizHtml = sentences.map((sentence, index) => {
                const words = sentence.split(/\s+/);
                const baseSentence = sentence.trim();
                const loopKey = buildLoopKey(baseSentence, index);
                const encodedLoopKey = encodeURIComponent(loopKey);
                const storedLoopCount = getLoopCount(loopKey);
                
                // Filter only English words (words containing at least one Latin letter)
                const englishWordIndices = [];
                words.forEach((word, idx) => {
                    if (/[a-zA-Z]/.test(word)) {
                        englishWordIndices.push(idx);
                    }
                });
                
                // Calculate how many English words to hide
                const numWordsToHide = Math.floor(englishWordIndices.length * percentToHide);

                const hiddenIndices = new Set();
                while (hiddenIndices.size < numWordsToHide && englishWordIndices.length > 0) {
                    const randomIndex = englishWordIndices[Math.floor(Math.random() * englishWordIndices.length)];
                    hiddenIndices.add(randomIndex);
                }

                const processedWords = words.map((word, wordIndex) => {
                    if (hiddenIndices.has(wordIndex)) {
                        if (currentMode === 'writing') {
                            return `<input type="text" class="hidden-word-input" data-word="${word}" placeholder="${'_'.repeat(word.length)}" style="width: ${word.length * 12 + 20}px;">`;
                        }
                        return `<span class="hidden-word" data-word="${word}">${'_'.repeat(word.length)}</span>`;
                    }
                    return word;
                }).join(' ');

                const lastChar = baseSentence.slice(-1);
                const processedSentence = processedWords + (lastChar === '.' || lastChar === '!' || lastChar === '?' ? lastChar : '');

                return `
                    <div class="sentence" data-index="${index}">
                        <div class="sentence-number">
                            <span class="number">${index + 1}.</span>
                            <div class="sentence-buttons">
                                <button class="answer-btn" title="Show answer">A</button>
                                <button class="copy-btn" title="Copy sentence">&#9636;&#9636;</button>
                            </div>
                        </div>
                        <span class="sentence-content">${processedSentence}</span>
                        <div class="sentence-actions" data-index="${index}" data-loop-key="${encodedLoopKey}">
                            <button class="speak-btn" title="Play sentence" data-index="${index}" data-loop-key="${encodedLoopKey}" data-sentence="${encodeURIComponent(baseSentence)}">▶</button>
                            <div class="loop-info" data-index="${index}" data-loop-key="${encodedLoopKey}">Loops: <span class="loop-count-value">${storedLoopCount}</span></div>
                            <span class="check-box" title="Mark as completed"></span>
                        </div>
                    </div>`;
            }).join('');

            quizArea.innerHTML = quizHtml;

            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.addEventListener('mousedown', revealAnswers);
                btn.addEventListener('mouseup', hideAnswers);
                btn.addEventListener('mouseleave', hideAnswers);
                btn.addEventListener('touchstart', revealAnswers);
                btn.addEventListener('touchend', hideAnswers);
            });

            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', copySentence);
            });

            document.querySelectorAll('.check-box').forEach(box => {
                box.addEventListener('click', toggleCompleted);
            });

            document.querySelectorAll('.hidden-word').forEach(word => {
                word.addEventListener('click', toggleWord);
            });
            
            initializeSpeechControls();
            
            // Writing mode: Add input event listeners
            document.querySelectorAll('.hidden-word-input').forEach(input => {
                input.addEventListener('input', handleWritingInput);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        checkWritingAnswer(input);
                    }
                });
                input.addEventListener('blur', () => checkWritingAnswer(input));
            });

            // Restore completed sentences by index
            document.querySelectorAll('.sentence').forEach((sentenceEl, idx) => {
                if (completedIndices.has(idx)) {
                    sentenceEl.classList.add('completed');
                }
            });

            updateProgress();
        }

        function initializeSpeechControls() {
            document.querySelectorAll('.loop-info').forEach(info => {
                const loopKey = decodeLoopKey(info.dataset.loopKey || '');
                const valueEl = info.querySelector('.loop-count-value');
                if (valueEl) {
                    valueEl.textContent = getLoopCount(loopKey);
                }
            });

            document.querySelectorAll('.speak-btn').forEach(btn => {
                updateSpeakButton(btn, false);
                if (!speechSupported) {
                    btn.disabled = true;
                    btn.title = 'Speech playback is not supported in this browser';
                    return;
                }
                btn.disabled = false;
                btn.addEventListener('click', handleSpeakToggle);
            });

            if (playAllBtn) {
                if (!speechSupported) {
                    playAllBtn.disabled = true;
                    playAllBtn.title = 'Speech playback is not supported in this browser';
                } else {
                    playAllBtn.disabled = false;
                    playAllBtn.title = 'Play all sentences on repeat';
                }
                updatePlayAllButton(globalPlaybackState.isPlaying);
            }
        }

        function handleSpeakToggle(event) {
            if (!speechSupported) {
                showToast('Speech playback is not supported in this browser.');
                return;
            }

            const button = event.currentTarget;
            const index = parseInt(button.dataset.index, 10);
            let sentenceText = '';

            try {
                sentenceText = decodeURIComponent(button.dataset.sentence || '');
            } catch (error) {
                sentenceText = button.dataset.sentence || '';
            }

            sentenceText = sentenceText.trim();

            if (!sentenceText) {
                showToast('Nothing to read for this sentence.');
                return;
            }

            if (speechState.isLooping && speechState.currentIndex === index) {
                stopSingleLoopPlayback();
                return;
            }

            stopGlobalPlayback();
            stopSingleLoopPlayback();

            speechState.currentIndex = index;
            speechState.currentButton = button;
            speechState.sentence = sentenceText;
            speechState.isLooping = true;

            updateSpeakButton(button, true);
            queueSpeech();
        }

        function queueSpeech() {
            if (!speechSupported || !speechState.isLooping || !speechState.sentence) {
                return;
            }

            if (speechState.loopTimeoutId) {
                clearTimeout(speechState.loopTimeoutId);
                speechState.loopTimeoutId = null;
            }

            const utterance = new SpeechSynthesisUtterance(speechState.sentence);
            configureUtterance(utterance);
            speechState.utterance = utterance;

            utterance.onend = () => {
                speechState.utterance = null;
                if (!speechState.isLooping || speechState.currentIndex === null) {
                    return;
                }
                incrementLoopCount(speechState.currentIndex);
                speechState.loopTimeoutId = setTimeout(() => {
                    if (speechState.isLooping) {
                        queueSpeech();
                    }
                }, 1000);
            };

            utterance.onerror = (error) => {
                speechState.utterance = null;
                if (isBenignSpeechError(error)) {
                    return;
                }
                console.error('Speech synthesis error:', error);
                showToast('Speech playback error.');
                stopSingleLoopPlayback({ skipCancel: true });
            };

            try {
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Speech synthesis speak error:', error);
                showToast('Unable to start speech playback.');
                stopSingleLoopPlayback({ skipCancel: true });
            }
        }

        function incrementLoopCount(index) {
            const loopInfo = document.querySelector(`.loop-info[data-index="${index}"]`);
            if (!loopInfo) {
                return;
            }
            const loopKey = decodeLoopKey(loopInfo.dataset.loopKey || '');
            const nextValue = getLoopCount(loopKey) + 1;
            setLoopCount(loopKey, nextValue);
            updateLoopDisplay(index, nextValue);
        }

        function updateLoopDisplay(index, value) {
            const target = document.querySelector(`.loop-info[data-index="${index}"] .loop-count-value`);
            if (target) {
                target.textContent = value;
            }
        }

        function updateSpeakButton(button, isPlaying) {
            if (!button) return;
            button.textContent = isPlaying ? '⏸' : '▶';
            button.setAttribute('aria-pressed', isPlaying ? 'true' : 'false');
            button.title = isPlaying ? 'Pause speech playback' : 'Play sentence';
        }

        function stopSingleLoopPlayback(options = {}) {
            const { skipCancel = false } = options;

            if (speechState.loopTimeoutId) {
                clearTimeout(speechState.loopTimeoutId);
                speechState.loopTimeoutId = null;
            }

            if (speechState.currentButton) {
                updateSpeakButton(speechState.currentButton, false);
            }

            speechState.isLooping = false;

            if (!skipCancel) {
                cancelActiveSpeech();
            }

            speechState.currentIndex = null;
            speechState.currentButton = null;
            speechState.sentence = '';
            speechState.utterance = null;
        }

        function cancelActiveSpeech() {
            if (!speechSupported) {
                return;
            }
            try {
                if (speechSynthesis.speaking || speechSynthesis.pending) {
                    speechSynthesis.cancel();
                }
            } catch (error) {
                console.error('Speech synthesis cancel error:', error);
            }
        }

        function stopAllPlayback() {
            stopGlobalPlayback({ skipCancel: true });
            stopSingleLoopPlayback({ skipCancel: true });
            cancelActiveSpeech();
        }

        function updatePlayAllButton(isPlaying) {
            if (!playAllBtn) {
                return;
            }
            playAllBtn.textContent = isPlaying ? 'Stop All' : 'Play All';
            playAllBtn.setAttribute('aria-pressed', isPlaying ? 'true' : 'false');
        }

        function toggleGlobalPlayback() {
            if (!speechSupported) {
                showToast('Speech playback is not supported in this browser.');
                return;
            }

            if (globalPlaybackState.isPlaying) {
                stopGlobalPlayback();
            } else {
                startGlobalPlayback();
            }
        }

        function startGlobalPlayback() {
            const speakButtons = Array.from(document.querySelectorAll('.speak-btn'));
            if (speakButtons.length === 0) {
                showToast('Generate a quiz first!');
                return;
            }

            stopSingleLoopPlayback();

            globalPlaybackState.isPlaying = true;
            globalPlaybackState.currentIndex = 0;
            globalPlaybackState.currentButton = null;
            updatePlayAllButton(true);

            playNextInGlobal();
        }

        function playNextInGlobal() {
            if (!globalPlaybackState.isPlaying) {
                return;
            }

            if (globalPlaybackState.timeoutId) {
                clearTimeout(globalPlaybackState.timeoutId);
                globalPlaybackState.timeoutId = null;
            }

            const speakButtons = Array.from(document.querySelectorAll('.speak-btn'));
            if (speakButtons.length === 0) {
                stopGlobalPlayback();
                return;
            }

            if (globalPlaybackState.currentIndex >= speakButtons.length) {
                globalPlaybackState.currentIndex = 0;
            }

            const button = speakButtons[globalPlaybackState.currentIndex];
            let sentenceText = '';
            try {
                sentenceText = decodeURIComponent(button.dataset.sentence || '');
            } catch (error) {
                sentenceText = button.dataset.sentence || '';
            }
            sentenceText = sentenceText.trim();

            if (!sentenceText) {
                globalPlaybackState.currentIndex = (globalPlaybackState.currentIndex + 1) % speakButtons.length;
                globalPlaybackState.timeoutId = setTimeout(() => playNextInGlobal(), 1000);
                return;
            }

            if (globalPlaybackState.currentButton && globalPlaybackState.currentButton !== button) {
                updateSpeakButton(globalPlaybackState.currentButton, false);
            }
            globalPlaybackState.currentButton = button;
            updateSpeakButton(button, true);

            const index = parseInt(button.dataset.index, 10);
            const utterance = new SpeechSynthesisUtterance(sentenceText);
            configureUtterance(utterance);
            globalPlaybackState.utterance = utterance;

            utterance.onend = () => {
                updateSpeakButton(button, false);
                globalPlaybackState.utterance = null;
                if (!globalPlaybackState.isPlaying) {
                    return;
                }
                incrementLoopCount(index);
                globalPlaybackState.currentIndex = (globalPlaybackState.currentIndex + 1) % speakButtons.length;
                globalPlaybackState.timeoutId = setTimeout(() => playNextInGlobal(), 1000);
            };

            utterance.onerror = (error) => {
                updateSpeakButton(button, false);
                globalPlaybackState.utterance = null;
                if (isBenignSpeechError(error)) {
                    if (globalPlaybackState.isPlaying) {
                        globalPlaybackState.timeoutId = setTimeout(() => playNextInGlobal(), 1000);
                    }
                    return;
                }
                console.error('Speech synthesis error:', error);
                showToast('Speech playback error.');
                stopGlobalPlayback({ skipCancel: true });
            };

            try {
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('Speech synthesis speak error:', error);
                showToast('Unable to start speech playback.');
                stopGlobalPlayback({ skipCancel: true });
            }
        }

        function stopGlobalPlayback(options = {}) {
            const { skipCancel = false } = options;

            if (globalPlaybackState.timeoutId) {
                clearTimeout(globalPlaybackState.timeoutId);
                globalPlaybackState.timeoutId = null;
            }

            if (globalPlaybackState.currentButton) {
                updateSpeakButton(globalPlaybackState.currentButton, false);
            }

            globalPlaybackState.isPlaying = false;
            globalPlaybackState.currentIndex = 0;
            globalPlaybackState.currentButton = null;
            globalPlaybackState.utterance = null;

            updatePlayAllButton(false);

            if (!skipCancel) {
                cancelActiveSpeech();
            }
        }

        function isBenignSpeechError(event) {
            if (!event) {
                return false;
            }
            return event.error === 'interrupted' || event.error === 'canceled';
        }
        
        function handleWritingInput(event) {
            const input = event.target;
            input.classList.remove('incorrect', 'correct');
        }
        
        function checkWritingAnswer(input) {
            if (input.classList.contains('correct')) return; // Already correct
            
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = input.dataset.word.toLowerCase();
            
            // Remove punctuation for comparison
            const cleanUserAnswer = userAnswer.replace(/[.,!?;:'"]/g, '');
            const cleanCorrectAnswer = correctAnswer.replace(/[.,!?;:'"]/g, '');
            
            if (cleanUserAnswer === cleanCorrectAnswer) {
                input.classList.add('correct');
                input.classList.remove('incorrect');
                input.value = input.dataset.word; // Show correct capitalization
                input.readOnly = true;
                showToast('Correct! ✓');
                
                // Move to next input
                focusNextInput(input);
            } else if (userAnswer !== '') {
                input.classList.add('incorrect');
                input.classList.remove('correct');
                setTimeout(() => {
                    input.classList.remove('incorrect');
                }, 300);
            }
        }
        
        function focusNextInput(currentInput) {
            const allInputs = Array.from(document.querySelectorAll('.hidden-word-input'));
            const currentIndex = allInputs.indexOf(currentInput);
            
            // Find next empty input
            for (let i = currentIndex + 1; i < allInputs.length; i++) {
                if (!allInputs[i].classList.contains('correct')) {
                    setTimeout(() => {
                        allInputs[i].focus();
                    }, 200);
                    return;
                }
            }
            
            // If no next input, blur current
            currentInput.blur();
        }
        

        function revealAnswers(event) {
            const sentenceContent = event.target.closest('.sentence').querySelector('.sentence-content');
            
            // Speaking mode: reveal hidden words
            sentenceContent.querySelectorAll('.hidden-word').forEach(word => {
                word.textContent = word.dataset.word;
                word.style.color = 'black';
            });
            
            // Writing mode: show answers in inputs
            sentenceContent.querySelectorAll('.hidden-word-input').forEach(input => {
                if (!input.classList.contains('correct')) {
                    input.value = input.dataset.word;
                    input.style.color = '#0071e3';
                    input.style.fontWeight = 'bold';
                }
            });
        }

        function hideAnswers(event) {
            const sentenceContent = event.target.closest('.sentence').querySelector('.sentence-content');
            
            // Speaking mode: hide words
            sentenceContent.querySelectorAll('.hidden-word:not(.revealed)').forEach(word => {
                word.textContent = '_'.repeat(word.dataset.word.length);
                word.style.color = '#e0e0e0';
            });
            
            // Writing mode: clear inputs
            sentenceContent.querySelectorAll('.hidden-word-input').forEach(input => {
                if (!input.classList.contains('correct')) {
                    input.value = '';
                    input.style.color = '';
                    input.style.fontWeight = '';
                }
            });
        }

        function toggleWord(event) {
            const word = event.target;
            word.classList.toggle('revealed');
            if (word.classList.contains('revealed')) {
                word.textContent = word.dataset.word;
            } else {
                word.textContent = '_'.repeat(word.dataset.word.length);
            }
        }

        function toggleCompleted(event) {
            const sentence = event.target.closest('.sentence');
            sentence.classList.toggle('completed');
            updateProgress();
            showToast('Memorized!');
        }

        function copySentence(event) {
            const sentence = event.target.closest('.sentence');
            const sentenceContent = sentence.querySelector('.sentence-content').textContent;
            
            const textArea = document.createElement('textarea');
            textArea.value = sentenceContent;
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                showToast('Copied!');
            } catch (err) {
                console.error('Failed to copy: ', err);
                showToast('Copy failed');
            }
            
            document.body.removeChild(textArea);
        }

        function downloadQuiz() {
            const quizContent = quizArea.innerText;
            const blob = new Blob([quizContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'memory_quiz.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function updateProgress() {
            const totalSentences = document.querySelectorAll('.sentence').length;
            const memorizedSentences = document.querySelectorAll('.sentence.completed').length;
            const percentage = Math.round((memorizedSentences / totalSentences) * 100) || 0;
            progressDiv.textContent = `Progress: ${memorizedSentences}/${totalSentences} (${percentage}%)`;
            
            const progressBarFill = document.querySelector('.progress-bar-fill');
            progressBarFill.style.width = `${percentage}%`;
        }

        function showToast(message) {
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 2000);
        }

        // 초기 진행 상황 업데이트
        updateProgress();
    </script>
</body>
</html>
